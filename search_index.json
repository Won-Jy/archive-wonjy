---
layout: null
permalink: /search_index.json
---

[
{% assign works = site.pages | where: "layout", "work" %}
{% for p in works %}

  {%- comment -%} ① Related texts 인덱싱 (그대로 유지) {%- endcomment -%}
  {% assign related_blob = "" %}
  {% if p.related_texts %}
    {% for rel in p.related_texts %}
      {% assign rid = rel.id | default: rel %}
      {% assign t = site.data.texts[rid] %}
      {% if t %}
        {% capture one %}
          {{ t.title_original.text_html | default: t.title_original | strip_html }}
          {% if t.title_translated %}
            {{ t.title_translated.text_html | default: t.title_translated | strip_html }}
          {% endif %}
          {% if t.author and t.author.name %} {{ t.author.name }}{% endif %}
          {% if t.year %} {{ t.year }}{% endif %}
        {% endcapture %}
        {% assign related_blob = related_blob | append: " " | append: one | strip %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {%- comment -%} ② Linked works 인덱싱 추가 {%- endcomment -%}
  {% assign linked_blob = "" %}
  {% if p.linked_works %}
    {% for lw in p.linked_works %}
      {%- comment -%}
        지원 형태:
        - 문자열(슬러그 or URL)
        - 객체 { id: "..."}  또는 { url: "..." }
      {%- endcomment -%}
      {% assign lw_id  = lw.id  | default: nil %}
      {% assign lw_url = lw.url | default: nil %}
      {% assign lw_raw = lw %} {# 문자열일 경우 대비 #}

      {%- assign target = nil -%}
      {%- if lw_url -%}
        {% assign target = works | where: "url", lw_url | first %}
      {%- elsif lw_id -%}
        {% assign target = works | where: "id",  lw_id  | first %}
      {%- else -%}
        {# 문자열로 들어온 경우: URL 우선, 없으면 id로 시도 #}
        {% assign target = works | where: "url", lw_raw | first %}
        {% if target == nil %}
          {% assign target = works | where: "id",  lw_raw | first %}
        {% endif %}
      {%- endif -%}

      {% if target %}
        {% capture one_linked %}
          {{ target.title }}
          {% if target.types %} {{ target.types | join: " " }} {% elsif target.type %} {{ target.type }} {% endif %}
          {% if target.year_start %} {{ target.year_start }}{% endif %}
          {% if target.year_end and target.year_end != target.year_start %} – {{ target.year_end }}{% endif %}
          {% if target.tags %} {{ target.tags | join: " " }}{% endif %}
        {% endcapture %}
        {% assign linked_blob = linked_blob | append: " " | append: one_linked | strip %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {%- comment -%} ③ 현재 작업의 본문 + Related + Linked 를 하나로 합치기 {%- endcomment -%}
  {% capture blob %}
    {{ p.title }}
    {% if p.summary %} {{ p.summary }} {% endif %}
    {% if p.description %} {{ p.description }} {% endif %}
    {% if p.types %} {{ p.types | join: " " }} {% elsif p.type %} {{ p.type }} {% endif %}
    {% if p.status %} {{ p.status }} {% endif %}
    {% if p.tags %} {{ p.tags | join: " " }} {% endif %}
    {{ related_blob }}
    {{ linked_blob }}
  {% endcapture %}

  {
    "url": {{ p.url | relative_url | jsonify }},
    "blob": {{ blob | strip_newlines | strip | jsonify }}
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
]
